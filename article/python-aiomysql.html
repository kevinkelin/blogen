<!DOCTYPE html>
<html lang="zh-CN">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)" />
<meta name="generator" content="Hugo 0.101.0" />
<link rel="shortcut icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/x-icon" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/imgs/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/imgs/icons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/imgs/icons/favicon.ico">
<meta itemprop="name" content="The use of aiomysql and sqlalchemy" />
<meta itemprop="description" content="Focus on python, Go language (golang), test development, project management" />
<meta itemprop="datePublished" ZgotmplZ />
<meta itemprop="dateModified" ZgotmplZ />
<meta itemprop="image" content="https://enblog.yangyanxing.com/imgs/xxxx.png" />
<meta itemprop="keywords" content="python,golang,java,android,blog,project management,python,Software Architecture" />

<meta property="og:type" content="article" />
<meta property="og:title" content="The use of aiomysql and sqlalchemy" />
<meta property="og:description" content="Focus on python, Go language (golang), test development, project management" />
<meta property="og:image" content="/imgs/xxxx.png" />
<meta property="og:image:width" content="312" />
<meta property="og:image:height" content="312" />
<meta property="og:image:type" content="image/jpeg/png/svg/jpg" />
<meta property="og:url" content="https://enblog.yangyanxing.com/article/python-aiomysql.html"/>
<meta property="og:site_name" content="KevinYang&#39;s blog" />
<meta property="og:locale" content="zh-CN"/>
<meta property="article:author" content="KevinYang" />
<meta property="article:published_time" content="2021-02-23 00:00:00 &#43;0000 UTC" />
<meta property="article:modified_time" content="2021-02-23 00:00:00 &#43;0000 UTC" />


  <link rel="stylesheet" href="//unpkg.com/@fortawesome/fontawesome-free@6.1.1/css/all.min.css">
  <link rel="stylesheet" href="//unpkg.com/animate.css@3.1.1/animate.min.css">

  <link rel="stylesheet" href="/css/main.min.7c5113ee442b14a1faba425503ad7883de282eee3c038f25121f41ed343d9f2f.css">
  <style type="text/css">
    .post-footer hr:after {
      content: "~ end ~";
    }
  </style>
  
  <title>The use of aiomysql and sqlalchemy - KevinYang&#39;s blog</title>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage"  class="use-motion" >
  <div class="headband"></div>
  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
<div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">KevinYang&#39;s blog</h1>
      <i class="logo-line"></i>
    </a>
    
      <p class="site-subtitle" itemprop="description">yangyanxing&#39;s blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
      
      <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>

<nav class="site-nav">
  <ul class="main-menu menu">
    <li class="menu-item menu-item-home">
      <a href="/" class="hvr-icon-pulse " rel="section"><i class="fa fa-home hvr-icon"></i>Home
      </a>
    </li>
    <li class="menu-item menu-item-About">
      <a href="/about.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-user hvr-icon"></i>about
      </a>
    </li>
    <li class="menu-item menu-item-Archives">
      <a href="/article.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-archive hvr-icon"></i>Archives
      </a>
    </li>
    <li class="menu-item menu-item-commonweal">
      <a href="/404.html" class="hvr-icon-pulse " rel="section"><i class="fa fa-heartbeat hvr-icon"></i>Welfare 404
      </a>
    </li>
    <li class="menu-item menu-item-search">
      <a role="button" class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search
      </a>
    </li>

  </ul>
</nav>
      </div>
      <div class="toggle sidebar-toggle" role="button">
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
  <span class="toggle-line"></span>
</div>
<aside class="sidebar">
  <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
    <ul class="sidebar-nav">
      <li class="sidebar-nav-toc">
        TOC
      </li>
      <li class="sidebar-nav-overview">
        Overview
      </li>
    </ul>
    <div class="sidebar-panel-container">
      
      <div class="post-toc-wrap sidebar-panel">
        <div class="post-toc animated"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#aiomysql-introduction">aiomysql introduction</a></li>
        <li><a href="#aiomysql-connection">aiomysql connection</a></li>
        <li><a href="#aiomysql-simple-curd">aiomysql simple CURD</a>
          <ul>
            <li><a href="#sql-injection-problem">SQL injection problem</a></li>
            <li><a href="#how-to-avoid-sql-injection">How to avoid SQL injection</a></li>
            <li><a href="#multi-parameter-query">Multi-parameter query</a></li>
            <li><a href="#combined-query">Combined query</a></li>
            <li><a href="#date-format-query">Date format query</a></li>
            <li><a href="#adding-data">adding data</a></li>
            <li><a href="#how-to-handle-insert-failure">How to handle insert failure</a></li>
            <li><a href="#cursor-type">cursor type</a></li>
          </ul>
        </li>
        <li><a href="#use-of-connection-pool">Use of connection pool</a></li>
        <li><a href="#transaction-processing">Transaction processing</a></li>
        <li><a href="#sqlalchemy-introduction">sqlalchemy introduction</a>
          <ul>
            <li><a href="#orm-introduction">ORM introduction</a></li>
          </ul>
        </li>
        <li><a href="#using-sqlalchemy-in-aiomysql">Using sqlalchemy in aiomysql</a></li>
        <li><a href="#curd-using-sqlalchemy">CURD using sqlalchemy</a>
          <ul>
            <li><a href="#simple-query-data">Simple query data</a></li>
            <li><a href="#select-which-columns-to-return">Select which columns to return</a></li>
            <li><a href="#conditional-query">Conditional query</a></li>
            <li><a href="#insert-operation">insert operation</a></li>
          </ul>
        </li>
        <li><a href="#complex-query-join">complex query join</a>
          <ul>
            <li><a href="#use_labels-problem">use_labels problem</a></li>
            <li><a href="#get-the-return-value-field-property">Get the return value field property</a></li>
          </ul>
        </li>
        <li><a href="#do-you-need-to-use-foreign-keys">Do you need to use foreign keys</a></li>
        <li><a href="#database-reconnection-problem">database reconnection problem</a></li>
        <li><a href="#whether-to-use-sqlalchemy">Whether to use sqlalchemy</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div>
      
      <div class="site-overview-wrap sidebar-panel">
        
<div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="KevinYang"
      src="/imgs/xxxx.png">
  <p class="site-author-name" itemprop="name">KevinYang</p>
  <div class="site-description" itemprop="description">Focus on python, Go language (golang), test development, project management</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
    <div class="site-state-item site-state-posts">
      <a href="/article.html">
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">Posts</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">
      <a href="/categories.html">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">Categories</span>
      </a>
    </div>
    <div class="site-state-item site-state-tags">
      <a href="/tags.html">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">Tags</span>
      </a>
    </div>
  </nav>
</div>
<div class="links-of-social site-overview-item animated">


  <span class="links-of-social-item">
    <a href="https://github.com/kevinkelin" title="Github → https://github.com/kevinkelin" rel="noopener" class="hvr-icon-pulse" target="_blank">
      <i class="fab fa-github fa-fw  hvr-icon "></i>Github
    </a>
  </span>
</div>
<div class="cc-license animated" itemprop="license">
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank" title="Creative Commons">
    <img src="/imgs/cc/big/by_nc_sa.svg" alt="Creative Commons">
  </a>
</div>
<div class="links-of-blogroll site-overview-item animated">
  <div class="links-of-blogroll-title">links
  </div>
  <ul class="links-of-blogroll-list">
    <li class="links-of-blogroll-item">
      <a href="https://www.liaoxuefeng.com/" title="https://www.liaoxuefeng.com/" target="_blank">廖雪峰</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://testerhome.com/" title="https://testerhome.com/" target="_blank">TesterHome</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://opentest.360.cn/" title="https://opentest.360.cn/" target="_blank">360开测</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://www.dongwm.com/" title="https://www.dongwm.com/" target="_blank">董伟明</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://studygolang.com/" title="https://studygolang.com/" target="_blank">go语言中文网</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://greyli.com/" title="https://greyli.com/" target="_blank">李辉的个人网站</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://www.flysnow.org/" title="https://www.flysnow.org/" target="_blank">飞雪无情</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://unknwon.cn/" title="https://unknwon.cn/" target="_blank">无闻</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://eddycjy.com/" title="https://eddycjy.com/" target="_blank">煎鱼</a>
    </li>
    <li class="links-of-blogroll-item">
      <a href="https://chai2010.cn/" title="https://chai2010.cn/" target="_blank">柴树杉</a>
    </li>
  </ul>
</div>
      </div>
    </div>
  </div>
</aside>
<div class="sidebar-dimmer"></div>
    </header>
    
    
  <div class="back-to-top" role="button" aria-label="Top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
    <div class="main-inner post posts-expand">
      
  <div class="post-block">
  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://enblog.yangyanxing.com/article/python-aiomysql.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/imgs/xxxx.png">
      <meta itemprop="name" content="KevinYang">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="KevinYang">
      <meta itemprop="description" content="Focus on python, Go language (golang), test development, project management">
    </span>
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="The use of aiomysql and sqlalchemy">
      <meta itemprop="description" content="I have been using tornado for projects before, and the database has been mostly using mongo and redis. With its excellent asynchronous features, it works very stably and efficiently. The recent project needs to use mysql, because moto and aioredis are used when using mongo and redis before. The database operation is performed asynchronously, so the database of asynchronous operation mysql is queried on the Internet. This article records the problems encountered in asynchronous operation and the corresponding solutions.">
    </span>
    <header class="post-header">
       <h1 class="post-title" itemprop="name headline">The use of aiomysql and sqlalchemy </h1> <div class="post-meta-container">
  <div class="post-meta-items">
    


<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-calendar"></i>
  </span>
  <span class="post-meta-item-text">Publish:</span>
  <time title="Publish:2021-02-23 00:00:00 &#43;0000 UTC" itemprop="dateCreated datePublished" datetime="2021-02-23 00:00:00 &#43;0000 UTC">2021-02-23</time>
</span>
    
    
<span class="post-meta-item">
  <span class="post-meta-item-icon">
    <i class="far fa-folder-open"></i>
  </span>
  <span class="post-meta-item-text">Classify at:</span>
  <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
    <a href="/categories/python.html" itemprop="url" rel="index">
      <span itemprop="name">python</span>
    </a>
  </span>
</span>
  </div>
  <div class="post-meta-items">
    
<span class="post-meta-item" title="Words">
  <span class="post-meta-item-icon">
    <i class="far fa-file-word"></i>
  </span>
  <span class="post-meta-item-text">Words:</span><span>8210</span>
</span>
    
<span class="post-meta-item" title="Read">
  <span class="post-meta-item-icon">
    <i class="far fa-clock"></i>
  </span>
  <span class="post-meta-item-text">Read:&asymp;</span>
  <span>39min</span>
</span>

    



  </div>
  
</div>

    </header>
    <div class="post-body" itemprop="articleBody">
      
  <p>I have been using tornado for projects before, and the database has been mostly using mongo and redis. With its excellent asynchronous features, it works very stably and efficiently. The recent project needs to use mysql, because moto and aioredis are used when using mongo and redis before. The database operation is performed asynchronously, so the database of asynchronous operation mysql is queried on the Internet. This article records the problems encountered in asynchronous operation and the corresponding solutions.</p>
<h2 id="aiomysql-introduction">aiomysql introduction</h2>
<p>When we use tornado to develop a website, we use the newly added asynchronous keyword <code>async/await</code> in python3, we use various asynchronous operations to perform various asynchronous operations, such as using <code>aiohttp</code> instead of <code>requests</code> to To perform asynchronous network request operations, use <code>motor</code> instead of the synchronous <code>pymongo</code> library to operate the mongo database. Similarly, when we develop synchronous python programs, we will use PyMySQL to operate the mysql database. Similarly, we will use aiomysql To asynchronously operate the mysql database.</p>
<h2 id="aiomysql-connection">aiomysql connection</h2>
<p>For simplicity, I downloaded the mysql:5.7 image using docker, then started a container, the password is 123456,</p>
<p><code>docker run --name mysql -e MYSQL_ROOT_PASSWORD=123456 -p 3306:3306 -d mysql:5.7</code></p>
<p>In this way, there is a mysql database, and then we will use this database as an example to execute various test code work.</p>
<p>Let&rsquo;s prepare some test data first, create a mytest database, create a user table with three fields, id, username, age, three simple fields, and add two pieces of data.</p>
<p><img src="https://yyxbloguse.oss-cn-beijing.aliyuncs.com/img/image-20201101213529264.png" alt="Test data"></p>
<p>First of all, let&rsquo;s make it clear that aiomysql can be a native connection to the mysql server, or you can use sqlalchemy (hereinafter referred to as sa) to connect to the mysql service. First, we use the native engine to connect, and then we will talk about sa to connect to the database.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#coding: utf-8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> aiomysql
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    conn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>connect(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cur <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>    r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> r:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no data&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>    conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above script can print out all the data in the database.</p>
<p>Let&rsquo;s take a look at the code and follow the execution flow.</p>
<ol>
<li>
<p>Create a connection</p>
<p>First, we use <code>aiomysql.connect()</code> to create a connection object conn. The code only uses the most common connection options. This connect() method returns a Connection class object. There are many parameters in this object. In the code, if encountered, it will be introduced accordingly.</p>
</li>
<li>
<p>Create a cursor</p>
<p>After that, we use the cursor method of the <code>conn</code> object to get the Cursor object cur, we can only use the cursor object to perform various operations on the database.</p>
</li>
<li>
<p>Execute the SQL statement</p>
<p>We execute the SQL statement using the execute() method of the cur object. Execute <code>select * from user</code> here. This method returns the number of rows affected. For the query, it is the amount of data that hits the query. We can also use the return value here. If it is 0, it means that there is no data that meets the query conditions. .</p>
<p>If the above code is changed to</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cur <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>    count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where id = 4&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;count:</span><span style="color:#f1fa8c">{}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(count))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>        r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no data&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>    conn<span style="color:#ff79c6">.</span>close()
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Close the cursor cur</p>
</li>
<li>
<p>Close the connection conn</p>
<p>Note that the close function of the conn object is not a coroutine, just call close() directly.</p>
</li>
</ol>
<p>Both the Connect class and the Cursor class in aiomysql implement the <code>__aexit__</code> method to ensure the closing of the cursor and the connection, so we often use the with context management to write code, so that we no longer have to deal with the closing of the cursor and connection. operate.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="aiomysql-simple-curd">aiomysql simple CURD</h2>
<p>Above, we simply used the cursor object to query. In this section, we will look at more CURD operations. In fact, there is not much relationship with aiomysql here. The main purpose is to test your mysql capabilities. An execute method goes all over the world.</p>
<p>But here we look at an old-fashioned problem, the sql injection problem.</p>
<h3 id="sql-injection-problem">SQL injection problem</h3>
<p>First let&rsquo;s look at the following code</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;yyx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;select * from user where username = &#39;</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#39;&#34;</span> <span style="color:#ff79c6">%</span> username
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(sql)
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(sql)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Suppose, the username is obtained from the user&rsquo;s input, such as the parameter input through web page post or get, without our processing, and then we look up the user in the database, for example, when the username is yyx, we spliced ​​the sql statement It is <code>select * from user where username = 'yyx'</code>, everything is going well at this time, we can get the data whose username is yyx, but if the user maliciously constructs sql, pass <code>yyx' or 1=1#</code> , then the sql string we receive is</p>
<p><code>select * from user where username = 'yyx' or 1=1#'</code> , this statement will execute the result of username is yyx or 1=1, 1=1 is a true condition, adding a # will The statement is treated as a comment, so this SQL statement will return all the data in the database. This creates an injection vulnerability.</p>
<h3 id="how-to-avoid-sql-injection">How to avoid SQL injection</h3>
<p>This is a big topic, and it can be said a lot in terms of expansion. Here we are just from the perspective of the framework to prevent some basic injection vulnerabilities. To prevent injection vulnerabilities, the programmer needs to perform necessary checks and filtering on the user&rsquo;s input. Always remember, don&rsquo;t trust user input.</p>
<p>Let&rsquo;s look at the execute method of the Cursor class</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">execute</span>(self, query, args<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34;Executes the given operation
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        Executes the given operation substituting any markers with
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        the given parameters.
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        For example, getting all rows where id is 5:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">          cursor.execute(&#34;SELECT * FROM t1 WHERE id = </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;, (5,))
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param query: ``str`` sql statement
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param args: ``tuple`` or ``list`` of arguments for sql query
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :returns: ``int``, number of rows that has been produced of affected
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> self<span style="color:#ff79c6">.</span>_get_db()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>nextset()):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> args <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>            query <span style="color:#ff79c6">=</span> query <span style="color:#ff79c6">%</span> self<span style="color:#ff79c6">.</span>_escape_args(args, conn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>_query(query)
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>_executed <span style="color:#ff79c6">=</span> query
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>_echo:
</span></span><span style="display:flex;"><span>            logger<span style="color:#ff79c6">.</span>info(query)
</span></span><span style="display:flex;"><span>            logger<span style="color:#ff79c6">.</span>info(<span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">%r</span><span style="color:#f1fa8c">&#34;</span>, args)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> self<span style="color:#ff79c6">.</span>_rowcount
</span></span></code></pre></td></tr></table>
</div>
</div><p>execute has two parameters, one is query, and the other is args. Let&rsquo;s look at the comments, query is a sql statement, and args is a parameter of type tulpe or list. If args is not empty, the script will reorganize the query through <code>query = query % self._escape_args(args, conn)</code>, and then look at the implementation of <code>_escape_args(args, conn)</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">_escape_args</span>(self, args, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(args, (<span style="color:#8be9fd;font-style:italic">tuple</span>, <span style="color:#8be9fd;font-style:italic">list</span>)):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">tuple</span>(conn<span style="color:#ff79c6">.</span>escape(arg) <span style="color:#ff79c6">for</span> arg <span style="color:#ff79c6">in</span> args)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">elif</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(args, <span style="color:#8be9fd;font-style:italic">dict</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">dict</span>((key, conn<span style="color:#ff79c6">.</span>escape(val)) <span style="color:#ff79c6">for</span> (key, val) <span style="color:#ff79c6">in</span> args<span style="color:#ff79c6">.</span>items())
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># If it&#39;s not a dictionary let&#39;s try escaping it anyways.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># Worst case it will throw a Value error</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> conn<span style="color:#ff79c6">.</span>escape(args)
</span></span></code></pre></td></tr></table>
</div>
</div><p>If it is a list or a tuple, it will return the tuple converted using <code>conn.escape</code>, if it is a dict dictionary type, it will return a dictionary, the key is still the original key, the value is <code>conn.escape(val)</code>, and finally both Use the <code>conn.escape()</code> function to convert, and then look at the implementation of this function</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">escape</span>(self, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;&#34;&#34; Escape whatever value you pass to it&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">isinstance</span>(obj, <span style="color:#8be9fd;font-style:italic">str</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#39;&#34;</span> <span style="color:#ff79c6">+</span> self<span style="color:#ff79c6">.</span>escape_string(obj) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&#39;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> escape_item(obj, self<span style="color:#ff79c6">.</span>_charset)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">escape_string</span>(self, s):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (self<span style="color:#ff79c6">.</span>server_status <span style="color:#ff79c6">&amp;</span>
</span></span><span style="display:flex;"><span>                SERVER_STATUS<span style="color:#ff79c6">.</span>SERVER_STATUS_NO_BACKSLASH_ESCAPES):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> s<span style="color:#ff79c6">.</span>replace(<span style="color:#f1fa8c">&#34;&#39;&#34;</span>, <span style="color:#f1fa8c">&#34;&#39;&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> escape_string(s)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The function will add two single quotes <code>' </code> around the incoming string, and replace the single quotes in the string with two single quotes, so that most sql injection problems can be avoided.</p>
<p>Let&rsquo;s modify the script</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where username = </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;</span>, username)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, we can get the data of the user name yangyanxing normally, and then change the user name to <code>yyx' or 1=1#</code> and try</p>
<p>At this time, the converted SQL statement is <code>select * from user where username = 'yyx\' or 1=1#'</code>. The single quotes have been escaped, and the user will not be found at this time.</p>
<p>Note that in order to avoid the problem of SQL injection, we must not splicing SQL statements by ourselves, but must check and escape the user&rsquo;s input.</p>
<h3 id="multi-parameter-query">Multi-parameter query</h3>
<p>The above only uses one parameter. Let&rsquo;s take a look at the use of multi-parameter queries. For example, we want to query users whose age is between 19 and 29. Normally, we should write sql as</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> <span style="color:#ff79c6">user</span> <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">19</span> <span style="color:#ff79c6">and</span> age<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">29</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We use the implementation of aiomysql</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where age&gt;</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c"> and age&lt;</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;</span>, (<span style="color:#bd93f9">19</span>, <span style="color:#bd93f9">29</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note here that <code>%d</code> cannot be used, because the value escaped using escape returns a string type, and even if the int type is passed, it returns a str.</p>
<h3 id="combined-query">Combined query</h3>
<p>Let&rsquo;s create another table to represent the occupation of the user in the user table, and create three pieces of data. The userid corresponds to the id in the user table. The reason why there is no foreign key here will be discussed later, just remember that the userid here is just an ordinary column, which represents the id in the user table.</p>
<p><img src="https://yyxbloguse.oss-cn-beijing.aliyuncs.com/img/image-20201102154947461.png" alt="image-20201102154947461"></p>
<p>There are three pieces of data here. In the user table, the id of 1 is qa and development, and the id of 2 is qa.</p>
<p>Let&rsquo;s find out what are the jobs of the user named yyx in the user table. Normally, we should write the sql statement as follows</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> jobs.jobs, <span style="color:#ff79c6">user</span>.username <span style="color:#ff79c6">from</span> jobs <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> <span style="color:#ff79c6">user</span> <span style="color:#ff79c6">ON</span> <span style="color:#ff79c6">user</span>.id<span style="color:#ff79c6">=</span>jobs.userid <span style="color:#ff79c6">where</span> <span style="color:#ff79c6">user</span>.username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;yyx&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>will get the following result</p>
<p><img src="https://yyxbloguse.oss-cn-beijing.aliyuncs.com/img/image-20201102162458606.png" alt="image-20201102162458606"></p>
<p>Implemented using aiomysql</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;SELECT jobs.jobs, user.username from jobs INNER JOIN user ON user.id=jobs.userid where user.username=</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#39;</span>
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(sql, (<span style="color:#f1fa8c">&#39;yyx&#39;</span>,))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>In general, using aiomysql for query operation is the same as using ordinary tools for mysql query. It is necessary to pay attention to the problem of injection. Be sure to use the escape function of the framework.</p>
<h3 id="date-format-query">Date format query</h3>
<p>Many times we need to perform date-type queries, such as querying data larger than a certain day, we first add an update column of the code update date to the user table, and fill in some data.</p>
<p>We use <code>count = await cur.execute(&quot;select * from user&quot;)</code> to query the data again, and we will get the following data</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>1, <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, 18, datetime.datetime<span style="color:#ff79c6">(</span>2020, 10, 31, 16, 43, 8<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>2, <span style="color:#f1fa8c">&#39;yyx&#39;</span>, 28, datetime.datetime<span style="color:#ff79c6">(</span>2020, 11, 1, 21, 44, 35<span style="color:#ff79c6">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we want to query data whose date is greater than October 31, 2020, we can write SQL like this</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> <span style="color:#ff79c6">user</span> <span style="color:#ff79c6">WHERE</span> DATE_FORMAT(updatedate,<span style="color:#f1fa8c">&#39;%Y%m%d&#39;</span>) <span style="color:#ff79c6">&gt;</span> <span style="color:#f1fa8c">&#39;20201031&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What if I use aiomysql to write sql?</p>
<p>If we write the following</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>datestr <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">31</span>)<span style="color:#ff79c6">.</span>strftime(<span style="color:#f1fa8c">&#39;%Y%m</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;</span>)
</span></span><span style="display:flex;"><span>count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user WHERE DATE_FORMAT(updatedate,&#39;%Y%m</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;) &gt; </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;</span>, (datestr,))
</span></span></code></pre></td></tr></table>
</div>
</div><p>will get an exception</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ValueError: unsupported format character <span style="color:#f1fa8c">&#39;Y&#39;</span> <span style="color:#ff79c6">(</span>0x59<span style="color:#ff79c6">)</span> at index <span style="color:#bd93f9">51</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When converting the spliced ​​string above, due to the existence of %Y, python does not support this conversion by default, so this is not acceptable.</p>
<p>In fact, there is no need to convert the data of datetime.datetime type, aiomysql will automatically convert it</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>datestr <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">31</span>)
</span></span><span style="display:flex;"><span>count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user WHERE updatedate &gt; </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;</span>, (datestr,))
</span></span></code></pre></td></tr></table>
</div>
</div><p>We only need to pass data of type datetime.datetime into the parameter.</p>
<p>pymysql has built-in processing methods for basic types</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>encoders <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">bool</span>: escape_bool,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">int</span>: escape_int,
</span></span><span style="display:flex;"><span>    long_type: escape_int,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">float</span>: escape_float,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">str</span>: escape_str,
</span></span><span style="display:flex;"><span>    text_type: escape_unicode,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">tuple</span>: escape_sequence,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">list</span>: escape_sequence,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">set</span>: escape_sequence,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">frozenset</span>: escape_sequence,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">dict</span>: escape_dict,
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">type</span>(<span style="color:#ff79c6">None</span>): escape_None,
</span></span><span style="display:flex;"><span>    datetime<span style="color:#ff79c6">.</span>date: escape_date,
</span></span><span style="display:flex;"><span>    datetime<span style="color:#ff79c6">.</span>datetime: escape_datetime,
</span></span><span style="display:flex;"><span>    datetime<span style="color:#ff79c6">.</span>timedelta: escape_timedelta,
</span></span><span style="display:flex;"><span>    datetime<span style="color:#ff79c6">.</span>time: escape_time,
</span></span><span style="display:flex;"><span>    time<span style="color:#ff79c6">.</span>struct_time: escape_struct_time,
</span></span><span style="display:flex;"><span>    Decimal: escape_object,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>These types do not need to be processed manually, just pass in the args parameter directly.</p>
<h3 id="adding-data">adding data</h3>
<p>With the foundation of querying the data above, let&rsquo;s look at the inserted data. We also compare the normal mysql statement and the query statement in aiomysql.</p>
<ol>
<li>Insert a single statement</li>
</ol>
<p>After the modification of the table, our table fields are as follows</p>
<p><img src="https://yyxbloguse.oss-cn-beijing.aliyuncs.com/img/image-20201102174416857.png" alt="image-20201102174416857"></p>
<p>Among them, the id is the primary key, which is self-increasing. When adding a new one, you don’t need to pass parameters. MySQL will add it automatically. The username and age cannot be empty. You must pass it when adding.</p>
<p>First use the SQL statement to add</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span><span style="color:#ff79c6">user</span><span style="color:#ff79c6">`</span> (username, age) <span style="color:#ff79c6">VALUES</span> (<span style="color:#f1fa8c">&#34;aaa&#34;</span>, <span style="color:#bd93f9">24</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>A data will be added</p>
<p><img src="https://yyxbloguse.oss-cn-beijing.aliyuncs.com/img/image-20201102175049744.png" alt="image-20201102175049744"></p>
<p>Use aiomysql to add</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user (username, age, updatedate) VALUES(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;ccc&#34;</span>, <span style="color:#bd93f9">33</span>, datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>now()))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(count)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;##########&#34;</span>)
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is noted here that, unlike the query, inserting data will have an additional <code>await conn.commit() </code> operation. If the commit method is not called here, the following query can also query the data just added, but at this time the data is not If it is not really added to the database, you must call the commit method, of course, you can not call it, then you need to add the <code>autocommit=True,</code> parameter when you want to initialize the connect, and we will talk about it in detail later when we talk about transactions.</p>
<p>For date type data, we don&rsquo;t need to process it, just pass in the parameters directly</p>
<ol start="2">
<li>
<p>Insert multiple statements</p>
<p>In addition to the execute method, cursor also has an executemany method, which can execute multiple SQL statements, which is very suitable for inserting multiple pieces of data</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        users <span style="color:#ff79c6">=</span> [
</span></span><span style="display:flex;"><span>            (<span style="color:#f1fa8c">&#34;eee&#34;</span>, <span style="color:#bd93f9">26</span>, datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2019</span>, <span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">23</span>)),
</span></span><span style="display:flex;"><span>            (<span style="color:#f1fa8c">&#34;fff&#34;</span>, <span style="color:#bd93f9">28</span>, datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2018</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">13</span>)),
</span></span><span style="display:flex;"><span>            (<span style="color:#f1fa8c">&#34;ggg&#34;</span>, <span style="color:#bd93f9">27</span>, datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2016</span>, <span style="color:#bd93f9">9</span>, <span style="color:#bd93f9">15</span>)),
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>executemany(<span style="color:#f1fa8c">&#34;insert into user ( username, age, updatedate) VALUES(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, users)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(count)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;##########&#34;</span>)
</span></span><span style="display:flex;"><span>        count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> count:
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;no user&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Put the data to be inserted into a tuple or list according to the format, and then use the executemany method to insert multiple pieces of data at one time.</p>
<p>In fact, looking at the implementation of executemany, it does not write multiple pieces of data at one time, but calls the execute method multiple times through a loop</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> arg <span style="color:#ff79c6">in</span> args:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>execute(query, arg)
</span></span><span style="display:flex;"><span>    rows <span style="color:#ff79c6">+=</span> self<span style="color:#ff79c6">.</span>_rowcount
</span></span><span style="display:flex;"><span>self<span style="color:#ff79c6">.</span>_rowcount <span style="color:#ff79c6">=</span> rows
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="how-to-handle-insert-failure">How to handle insert failure</h3>
<p>Insertion failures often occur, such as duplicate primary keys and unequal data types. We need to catch these exceptions to handle them.</p>
<p>For example the following sentence</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user (id, username, age, updatedate) VALUES(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>,(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;ddd&#34;</span>, <span style="color:#bd93f9">34</span>, datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>now ()))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Try to add a data with a primary key id of 1, but since the primary key already exists in the database, this insertion will definitely fail</p>
<p>Program will report</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pymysql.err.IntegrityError: <span style="color:#ff79c6">(</span>1062, <span style="color:#f1fa8c">&#34;Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39;&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pymysql.err Errors</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user (id, username, age, updatedate) VALUES(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;ddd&#34;</span>, <span style="color:#bd93f9">34</span>, datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>now ()))
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(count)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span> pymysql<span style="color:#ff79c6">.</span>err<span style="color:#ff79c6">.</span>IntegrityError <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(e)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">raise</span> e
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, <code>(1062, &quot;Duplicate entry '1' for key 'PRIMARY'&quot;)</code> exception message will be printed</p>
<h3 id="cursor-type">cursor type</h3>
<p>When you can initialize the cursor type, choose a different class, the default return is in the form of a tuple</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>1, <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, 18, datetime.datetime<span style="color:#ff79c6">(</span>2020, 10, 31, 16, 43, 8<span style="color:#ff79c6">)</span>, 0<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>2, <span style="color:#f1fa8c">&#39;yyx&#39;</span>, 28, datetime.datetime<span style="color:#ff79c6">(</span>2020, 11, 1, 21, 44, 35<span style="color:#ff79c6">)</span>, 2<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>3, <span style="color:#f1fa8c">&#39;aaa&#39;</span>, 24, None, None<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>8, <span style="color:#f1fa8c">&#39;ccc&#39;</span>, 33, datetime.datetime<span style="color:#ff79c6">(</span>2020, 11, 2, 17, 59, 38<span style="color:#ff79c6">)</span>, None<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>27, <span style="color:#f1fa8c">&#39;aaa&#39;</span>, 16, None, None<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Can be initialized using the <code>aiomysql.cursors.DictCursor</code> class</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>conn<span style="color:#ff79c6">.</span>cursor(aiomysql<span style="color:#ff79c6">.</span>cursors<span style="color:#ff79c6">.</span>DictCursor) <span style="color:#ff79c6">as</span> cur
</span></span></code></pre></td></tr></table>
</div>
</div><p>The obtained result will be returned in the form of a dictionary</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{<span style="color:#f1fa8c">&#39;id&#39;</span>: <span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: <span style="color:#bd93f9">18</span>, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">10</span>, <span style="color:#bd93f9">31</span>, <span style="color:#bd93f9">16</span>, <span style="color:#bd93f9">43</span>, <span style="color:#bd93f9">8</span>), <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: <span style="color:#bd93f9">0</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#f1fa8c">&#39;id&#39;</span>: <span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;yyx&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: <span style="color:#bd93f9">28</span>, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">21</span>, <span style="color:#bd93f9">44</span>, <span style="color:#bd93f9">35</span>), <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: <span style="color:#bd93f9">2</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#f1fa8c">&#39;id&#39;</span>: <span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;aaa&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: <span style="color:#bd93f9">24</span>, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: <span style="color:#ff79c6">None</span>, <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: <span style="color:#ff79c6">None</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#f1fa8c">&#39;id&#39;</span>: <span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;ccc&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: <span style="color:#bd93f9">33</span>, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">17</span>, <span style="color:#bd93f9">59</span>, <span style="color:#bd93f9">38</span>), <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: <span style="color:#ff79c6">None</span>}
</span></span><span style="display:flex;"><span>{<span style="color:#f1fa8c">&#39;id&#39;</span>: <span style="color:#bd93f9">27</span>, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;aaa&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: <span style="color:#bd93f9">16</span>, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: <span style="color:#ff79c6">None</span>, <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: <span style="color:#ff79c6">None</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="use-of-connection-pool">Use of connection pool</h2>
<p>We have been using the <code>aiomysql.connect()</code> method to connect to the database before. aiomysql also provides a connection pool interface. With a connection pool, there is no need to frequently open and close database connections.</p>
<p>In the above code, we all execute a function to create a connection. We know that creating a connection between the client and the server is also a time-consuming and resource-consuming operation, so we will use the connection pool to reduce frequent openings with the mysql database. and close the connection.</p>
<p>This is only one of the reasons, and there is a more important reason, because in the coroutine program, everyone shares a thread, for example, there are two functions, one function is to query the user table, and the other is to query the jobs table.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    conn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>connect(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_user</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>            count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> count:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;get data from user&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_jobs</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>            count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from jobs&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> count:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>            r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;get data from jobs...&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>gather(get_jobs(), get_user())
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>We wrote two sub-functions in the test() function, get_user and get_jobs get data from the user table and the jobs table respectively, of course we can use</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">await</span> get_user()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">await</span> get_jobs()
</span></span></code></pre></td></tr></table>
</div>
</div><p>to execute separately, but this method is synchronous and not executed asynchronously.</p>
<p>We want these two functions to be done asynchronously, so we use</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>gather(get_jobs(), get_user())
</span></span></code></pre></td></tr></table>
</div>
</div><p>Called in this way, the two coroutines are executed in parallel, but writing in this way will report an error</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>RuntimeError: readexactly<span style="color:#ff79c6">()</span> called <span style="color:#ff79c6">while</span> another coroutine is already waiting <span style="color:#ff79c6">for</span> incoming data
</span></span></code></pre></td></tr></table>
</div>
</div><p>It means that a coroutine is waiting for data to come over, but at this time another coroutine also starts to read data, because the two coroutines use the same connection object conn.</p>
<p>So here we need to use two different connections. Of course, we can reconnect the mysql data in each function, and then close it after the query operation is executed, but this will cause the frequent creation of connections, which will cause some problems. The waste of resources, and the performance of the website will also be affected.</p>
<p>So at this time we need to use the connection pool, the connection pool will save a certain number of connection objects, each function takes a connection object from the pool when it needs to be used, and then puts the connection object in the pool after use, so as to avoid Frequent open and close operations with the mysql database, and also avoid the above exceptions that occur when the same connection is used in different coroutine objects.</p>
<p>Modify the above code</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>create_pool(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        minsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>        maxsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>        echo<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        autocommit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_user</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">id</span>(conn), <span style="color:#f1fa8c">&#39;in get user&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> count:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>                r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;get data from user&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_jobs</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">id</span>(conn), <span style="color:#f1fa8c">&#39;in get jobs&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from jobs&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> count:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>                r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;get data from jobs...&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_email</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">id</span>(conn), <span style="color:#f1fa8c">&#39;in get email&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                count <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from email&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> count:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>                r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;get data from email...&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> r:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>gather(get_jobs(), get_user(), get_email())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>The initialization function of the connection pool <code>aiomysql.create_pool</code> has similar parameters to <code>aiomysql.connect</code>, the basic information of the database, there are two more parameters <code>minsize, maxsize,</code> the minimum number of connections and the maximum number of connections, I here for the experiment, will The maximum number of connections is set to 2, and then three functions are used below to obtain the connection pool. We print out the id information of the connection object conn to see</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#bd93f9">2977786527496</span> in get <span style="color:#8be9fd;font-style:italic">jobs</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">2977786527496</span> in get user
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">2977786590984</span> in get email
</span></span></code></pre></td></tr></table>
</div>
</div><p>It can be seen that the get jobs function and the get user function use the same connection object.</p>
<p>The above script no longer reports an error, and the information in the database can be obtained normally, and the query is performed asynchronously.</p>
<p>We should also note that because it is a demo code, we are not very good at writing such code during the development process. More often, we are writing web programs, such as writing a web program with tornado. Different interfaces need to be different. In order to ensure that the query is performed at the same time, we need to use the connection pool at this time.</p>
<h2 id="transaction-processing">Transaction processing</h2>
<p>There are a lot of introductions about transactions on the Internet. Database transactions have four characteristics of ACID: atomicity, consistency, isolation, persistence, and the problems of dirty reads, non-repeatable reads, and phantom reads caused by different isolation levels. , I recommend Liao Xuefeng&rsquo;s sql tutorial, which is very clear.</p>
<p>
<a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611198786848" title="Transactions in MySQL" rel="noopener external nofollow noreferrer" target="_blank" class=" exturl">
    Transactions in MySQL
    <i class="fa fa-external-link-alt"></i>
</a></p>
<p>Here is an introduction to the processing of transactions in aiomysql.</p>
<p>Previously, when we initialized the connection or connection pool, we added <code>autocommit=True,</code> this setting, autocommit=True means automatic commit, when using transaction, it needs to be closed, or not set, the default is False</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user(username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;aaa&#34;</span>, <span style="color:#bd93f9">16</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># do not call conn.commit()</span>
</span></span><span style="display:flex;"><span>            c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>            result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, we can get the data we just inserted, but if we use other mysql clients to view, the data just now has not been submitted, then we need to call <code>conn.commit()</code> to submit the transaction before it can be really Write data to the database.</p>
<p>Of course, when executing <code>conn.commit()</code>, it is possible to fail, such as inserting half of the data and being interfered by other transactions, then an exception will be thrown here</p>
<p>Now there is a question, since we can set <code>autocommit=True</code> to let the database automatically commit the transaction, why do we have to start the transaction ourselves, and then manually call <code>conn.commit()</code> to commit it?</p>
<p>Let&rsquo;s assume that there is such a scenario. If you want to update two tables with two SQL statements, such as a traditional transfer, your balance is decreased by 200, and his balance is increased by 200. In the case of <code>autocommit=True</code> , First use a line of code to update a table, then it crashes when updating another table. At this time, because <code>autocommit=True</code> is used, the first statement is updated successfully, and the second statement fails</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor(aiomysql<span style="color:#ff79c6">.</span>cursors<span style="color:#ff79c6">.</span>DictCursor) <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user(username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;aaa&#34;</span>, <span style="color:#bd93f9">16</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user(username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;aaa2&#34;</span>, <span style="color:#bd93f9">13</span>, <span style="color:#bd93f9">1111</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(e)
</span></span><span style="display:flex;"><span>            c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>            result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the above statement, the first insert statement has no problem and can be inserted into the database normally, but the second statement, due to a problem with the format conversion, will crash at this time, and the second statement will not be inserted successfully.</p>
<p>But now the problem is coming. I ask that these two statements are either fully executed or not executed. The above code cannot guarantee the consistency of the data, which destroys the atomicity and consistency of the transaction, so we need to use Do things manually by yourself.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor(aiomysql<span style="color:#ff79c6">.</span>cursors<span style="color:#ff79c6">.</span>DictCursor) <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>begin() <span style="color:#6272a4"># start the transaction</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user(username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;aaa&#34;</span>, <span style="color:#bd93f9">16</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user(username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;aaa2&#34;</span>, <span style="color:#bd93f9">13</span>, <span style="color:#bd93f9">1111</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>commit()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(e)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>rollback() <span style="color:#6272a4">#rollback</span>
</span></span><span style="display:flex;"><span>            c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user&#34;</span>)
</span></span><span style="display:flex;"><span>            result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Above, <code>await conn.begin()</code> is used to start the transaction, and then <code>await conn.commit()</code> is used to commit the transaction. If there is a failure or crash in the process, <code>await conn.rollback()</code> is executed to roll back.</p>
<p>At this point, the first statement will not be inserted successfully. If the <code>autocommit=True</code> parameter is set when initializing the connection or connection pool, you need to call <code>conn.begin()</code> here, if the autocommit parameter is not set, the default If it is False, there is no need to explicitly call conn.begin() later, but you need to explicitly call <code>conn.commit()</code></p>
<h2 id="sqlalchemy-introduction">sqlalchemy introduction</h2>
<p>The following content comes from Wikipedia</p>
<blockquote>
<p>SQLAlchemy is an open source software under the Python programming language. Provides a SQL toolkit and an object-relational mapping (ORM) tool, released under the MIT license.</p>
<p>SQLAlchemy &ldquo;implements a complete enterprise-grade persistence model in a simple Python language, designed for efficient and high-performance database access.&rdquo; The philosophy of SQLAlchemy is that the magnitude and performance of SQL databases are more important than object collections; and the abstraction of object collections is more important than tables and rows. Therefore, SQLAlchmey adopts a data mapping model similar to Hibernate in Java [4], rather than the Active Record model adopted by other ORM frameworks. However, optional plugins such as Elixir[5] and declarative allow users to use declarative syntax.</p>
<p>SQLAlchemy was first released in February 2006 and quickly became one of the most widely used ORM tools in the Python community, as much as Django&rsquo;s ORM framework.</p>
</blockquote>
<h3 id="orm-introduction">ORM introduction</h3>
<p>ORM, the full name of Object-Relational Mapping, maps the table structure of the relational database to the object, so that the relationship of the operation database is converted into the object in the operation python</p>
<h2 id="using-sqlalchemy-in-aiomysql">Using sqlalchemy in aiomysql</h2>
<p>When using the native mysql connection of aiomysql, we use the <code>aiomysql.connect</code> function to obtain the aiomysql connection object. When using sqlalchemy, you need to use the <code>aiomysql.sa.create_engine</code> function to create an engine object</p>
<p>In aiomysql, you can&rsquo;t use classes to define, you need to use aiomysql.sa.Table to return ORM objects, and you can&rsquo;t use sessions, and you need to perform query operations on a connection object.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> aiomysql
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pymysql
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sqlalchemy <span style="color:#ff79c6">as</span> sa
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> aiomysql.sa <span style="color:#ff79c6">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metadata <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>MetaData()
</span></span><span style="display:flex;"><span>user <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>Table(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#34;user&#34;</span>,
</span></span><span style="display:flex;"><span>    metadata,
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#34;id&#34;</span>, sa<span style="color:#ff79c6">.</span>Integer, primary_key<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, autoincrement<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#39;username&#39;</span>, sa<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">255</span>), nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, default<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#39;age&#39;</span>, sa<span style="color:#ff79c6">.</span>Integer, nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#39;updatedate&#39;</span>, sa<span style="color:#ff79c6">.</span>DateTime, nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#39;isstudent&#39;</span>, sa<span style="color:#ff79c6">.</span>Boolean, nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    engine <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> create_engine(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        autocommit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> engine<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(query)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> result<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>When using sqlalchemy, to define the ORM relationship first, you can use sqlalchemy.Table to define it.</p>
<ol>
<li>
<p>Create a metaclass</p>
<p>Use <code>metadata = sa.MetaData()</code> to create a metaclass, this metaclass will contain the relationships of various tables, which will be introduced later</p>
</li>
<li>
<p>Create the table</p>
<p>Use the metaclass metadata created above to create a table structure, the first field is the table name, the second parameter is the metaclass object, followed by the information object of each field, the first is the field name, the second is the type , followed by some field options</p>
<p>Here are some commonly used data types</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Integer</td>
<td>Shaper</td>
</tr>
<tr>
<td>String (size)</td>
<td>String</td>
</tr>
<tr>
<td>Text</td>
<td>Text</td>
</tr>
<tr>
<td>DateTime</td>
<td>The time corresponding to python datetime</td>
</tr>
<tr>
<td>Float</td>
<td>Floating point</td>
</tr>
<tr>
<td>Boolean</td>
<td>Boolean</td>
</tr>
<tr>
<td>PickleType</td>
<td>python memory object</td>
</tr>
<tr>
<td>LargeBinary</td>
<td>Binary data</td>
</tr>
</tbody>
</table>
<p>Here are some common field properties</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>primary_key: is the primary key
</span></span><span style="display:flex;"><span>autoincrement: whether to auto-increment
</span></span><span style="display:flex;"><span>index: whether it is an index
</span></span><span style="display:flex;"><span>nullable: whether it can be null, when True, it can be null
</span></span><span style="display:flex;"><span>comment: comment
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>
<p>Create the engine</p>
</li>
<li>
<p>Get the connection</p>
<p>Acquire a connection via engine.acquire()</p>
</li>
<li>
<p>Execute the query statement</p>
<p>This is different from aiomysql, where the <code>execute(query)</code> method of the connection object conn is used directly</p>
</li>
<li>
<p>Print the display result</p>
</li>
</ol>
<p>The SQL statement called here is rather obscure and difficult to understand when using SQL directly or using the execute of aiomysql above. The implementation of various queries in sqlalchemy will be recorded in detail below.</p>
<h2 id="curd-using-sqlalchemy">CURD using sqlalchemy</h2>
<h3 id="simple-query-data">Simple query data</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(query)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The constructed SQL statement can be printed by <code>str(query)</code></p>
<p>The above query is converted to SQL statement as</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#f1fa8c">&#34;user&#34;</span>.id, <span style="color:#f1fa8c">&#34;user&#34;</span>.username, <span style="color:#f1fa8c">&#34;user&#34;</span>.age, <span style="color:#f1fa8c">&#34;user&#34;</span>.updatedate, <span style="color:#f1fa8c">&#34;user&#34;</span>.isstudent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#f1fa8c">&#34;user&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Same as <code>select * from user</code>.</p>
<p><code>sa.select([user])</code> The select() function parameter must be a list or an iterable object. This simple query does not need to provide the from table, sa will automatically figure out which table to query in.</p>
<h3 id="select-which-columns-to-return">Select which columns to return</h3>
<p>By default, all fields in the table will be returned. When you need to specify which fields to return, you need to set</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>updatedate, user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>username])
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can use user.columns.updatedate, to return the updatedate field, and columns can also be abbreviated as c, such as <code>user.c.username</code> later, the above query is converted into an SQL statement <code>SELECT user.updatedate, user.username FROM user</code>.</p>
<h3 id="conditional-query">Conditional query</h3>
<p>You can set the query conditions by calling the where() function after the select() function</p>
<ol>
<li>
<p>Query the data whose username is yyx</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;yyx&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that user.columns, or user.c is also used here</p>
<p>In the return value, since we set the isstudent field to <code>sa.Boolean</code> when we define user, at this time, when the value is 0, the value is False, and when it is not 0, it is True</p>
<p>The above printout is <code>(2, 'yyx', 28, datetime.datetime(2020, 11, 1, 21, 44, 35), True)</code></p>
</li>
<li>
<p>Anti-injection</p>
<p>In the above code, if we use the query condition constructed before that can be injected, let&rsquo;s see what happens.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;yyx&#39; or 1=1#&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The resulting query statement is</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">user</span>.id, <span style="color:#ff79c6">user</span>.username, <span style="color:#ff79c6">user</span>.age, <span style="color:#ff79c6">user</span>.updatedate, <span style="color:#ff79c6">user</span>.isstudent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">user</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">user</span>.username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;yyx\&#39;</span> <span style="color:#ff79c6">or</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">#</span><span style="color:#f1fa8c">&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And without getting the task result, we noticed that sa has already helped us escape the single quotes. So we don&rsquo;t need to do any more processing here.</p>
</li>
<li>
<p>Multi-condition query</p>
<p>Sometimes we use multiple conditional queries, for example, we want to find user information whose age is greater than 24 and whose id is less than 11.</p>
<p>The logical query relationship can be divided into or (or) and (and) not (not) relationship, we can use <code>and_, or_, not_</code> in sqlalchemy.sql to specify the logical relationship. Note here for and python keywords There is an underscore as a distinction</p>
<p>The query conditions here can be seen asYes and relationship, we can use the and_ operation</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> engine<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        w <span style="color:#ff79c6">=</span> and_(
</span></span><span style="display:flex;"><span>            user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">11</span>,
</span></span><span style="display:flex;"><span>            user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>age <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">14</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(w)
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">str</span>(query))
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(query)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> result<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we define an and_ object, which sets the conditions to be queried, and then puts this variable into the where() function</p>
<p>The above query is converted into an SQL statement as</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">user</span>.id, <span style="color:#ff79c6">user</span>.username, <span style="color:#ff79c6">user</span>.age, <span style="color:#ff79c6">user</span>.updatedate, <span style="color:#ff79c6">user</span>.isstudent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">user</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">user</span>.id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">11</span> <span style="color:#ff79c6">AND</span> <span style="color:#ff79c6">user</span>.age <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">14</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The same is true for OR or NOT, you only need to put the set queries in sequence.</p>
</li>
<li>
<p>Date query</p>
<p>We want to query user information whose update date is greater than 2020-11-02</p>
<p>It is relatively simple here, you can use the datetime object directly to do the comparison</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>updatedate<span style="color:#ff79c6">&gt;</span>datetime<span style="color:#ff79c6">.</span>datetime(<span style="color:#bd93f9">2020</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">2</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, it can also be accurate to seconds, in short, pass in a datetime object.</p>
<p>Converted to SQL statement as</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">user</span>.id, <span style="color:#ff79c6">user</span>.username, <span style="color:#ff79c6">user</span>.age, <span style="color:#ff79c6">user</span>.updatedate, <span style="color:#ff79c6">user</span>.isstudent
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">user</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">user</span>.updatedate <span style="color:#ff79c6">&gt;</span> <span style="color:#f1fa8c">&#39;2020-11-02 00:00:00&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>False query and None query</p>
<p>We define user&rsquo;s isstudent as Boolean type, we can pass</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>isstudent<span style="color:#ff79c6">==</span><span style="color:#ff79c6">False</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>to find data where isstudent is False,</p>
<p>Query a piece of data</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>1, <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, 18, datetime.datetime<span style="color:#ff79c6">(</span>2020, 10, 31, 16, 43, 8<span style="color:#ff79c6">)</span>, False<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, it is impossible to find the data in the table that has not set this field. False and None here are different. If you want to get the data without the isstudens field set, you need to use</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user])<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>columns<span style="color:#ff79c6">.</span>isstudent<span style="color:#ff79c6">==</span><span style="color:#ff79c6">None</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>to obtain.</p>
</li>
</ol>
<h3 id="insert-operation">insert operation</h3>
<p>The insertion operation of sa is very flexible. There are many insertion methods. The following tests are carried out in turn.</p>
<ol>
<li>
<p>Use the values ​​function</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(user<span style="color:#ff79c6">.</span>insert()<span style="color:#ff79c6">.</span>values(username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;fan&#34;</span>, age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">16</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this way, the required parameters are passed as parameters of the values ​​function, and the parameters defined as nullable as True can be omitted here.</p>
</li>
<li>
<p>Insert using dictionary dict format</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>userinfo <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;username&#34;</span>: <span style="color:#f1fa8c">&#34;hhh&#34;</span>,<span style="color:#f1fa8c">&#34;age&#34;</span>: <span style="color:#bd93f9">33</span>,<span style="color:#f1fa8c">&#34;id&#34;</span>: <span style="color:#ff79c6">None</span>,<span style="color:#f1fa8c">&#34;updatedate&#34;</span>:<span style="color:#ff79c6">None</span>,<span style="color:#f1fa8c">&#34;isstudent&#34;</span>:<span style="color:#ff79c6">None</span>}
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(user<span style="color:#ff79c6">.</span>insert(), userinfo)
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method needs to define each field in the definition Table table, even if the field is set to nullable=True, if you don&rsquo;t want to assign a value, write None here.</p>
</li>
<li>
<p>Insert using tuple</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(user<span style="color:#ff79c6">.</span>insert(), (<span style="color:#ff79c6">None</span>, <span style="color:#f1fa8c">&#34;yang&#34;</span>, <span style="color:#bd93f9">88</span>, <span style="color:#ff79c6">None</span>, <span style="color:#ff79c6">True</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this way, the values ​​need to be passed in according to the order of the fields in the defined Table. The value that is also empty should use None to occupy the place even if it does not want to be set now, and the order should be in the order in which the table structure was defined.</p>
</li>
<li>
<p>The way to use named parameters</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(user<span style="color:#ff79c6">.</span>insert(), <span style="color:#8be9fd;font-style:italic">id</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>, username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;lllll&#34;</span>, age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">99</span>,
</span></span><span style="display:flex;"><span>                                    updatedate<span style="color:#ff79c6">=</span>datetime<span style="color:#ff79c6">.</span>datetime<span style="color:#ff79c6">.</span>now(), isstudent<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this way parameters may not be in the order in which they are defined.</p>
</li>
<li>
<p>Insert data by position</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(user<span style="color:#ff79c6">.</span>insert(), <span style="color:#ff79c6">None</span>, <span style="color:#f1fa8c">&#34;mmmm&#34;</span>, <span style="color:#bd93f9">9</span>, <span style="color:#ff79c6">None</span>, <span style="color:#ff79c6">None</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>This method does not need to write the field name, but also needs to pass in the parameters in order.</p>
</li>
</ol>
<h2 id="complex-query-join">complex query join</h2>
<p>Or take the previous example, if you want to query the jobs of the user named yyx in the user table, we normally write the sql statement as follows</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> jobs.jobs, <span style="color:#ff79c6">user</span>.username <span style="color:#ff79c6">from</span> jobs <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> <span style="color:#ff79c6">user</span> <span style="color:#ff79c6">ON</span> <span style="color:#ff79c6">user</span>.id<span style="color:#ff79c6">=</span>jobs.userid <span style="color:#ff79c6">where</span> <span style="color:#ff79c6">user</span>.username<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;yyx&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In sa, we need to use <code>select_from</code> function to define JOIN</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># Define the jobs table structure</span>
</span></span><span style="display:flex;"><span>jobs <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>Table(
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;jobs&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#34;id&#34;</span>, sa<span style="color:#ff79c6">.</span>Integer, primary_key<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, autoincrement<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#34;jobs&#34;</span>, sa<span style="color:#ff79c6">.</span>String(<span style="color:#bd93f9">50</span>), nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, default<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;qa&#34;</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#ff79c6">.</span>Column(<span style="color:#f1fa8c">&#34;userid&#34;</span>, sa<span style="color:#ff79c6">.</span>Integer, nullable<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> engine<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>        j <span style="color:#ff79c6">=</span> user<span style="color:#ff79c6">.</span>join(jobs, user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>id <span style="color:#ff79c6">==</span> jobs<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>userid)
</span></span><span style="display:flex;"><span>        query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>username, jobs<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>jobs])<span style="color:#ff79c6">.</span>select_from(j)<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;yyx&#39;</span>)
</span></span><span style="display:flex;"><span>        result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>execute(query)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> result<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span></code></pre></td></tr></table>
</div>
</div><p>First, sa.select passes in the fields to be returned. Here we use <code>user.c.username, jobs.c.jobs</code>, and then use select_from to define the join conditions. The first parameter of join is the table to be connected, followed by the definition of the connection conditions of.</p>
<p>The SQL statement obtained by the above code is</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">user</span>.username, jobs.jobs
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">user</span> <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> jobs <span style="color:#ff79c6">ON</span> <span style="color:#ff79c6">user</span>.id <span style="color:#ff79c6">=</span> jobs.userid
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">user</span>.username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;yyx&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is INNER JOIN, corresponding to outerjoin.</p>
<h3 id="use_labels-problem">use_labels problem</h3>
<p>If we define query like this</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>j <span style="color:#ff79c6">=</span> user<span style="color:#ff79c6">.</span>join(jobs, user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>id <span style="color:#ff79c6">==</span> jobs<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>userid)
</span></span><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user, jobs])<span style="color:#ff79c6">.</span>select_from(j)<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;yyx&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>We want to get all the fields of user and jobs, and an error will be reported at this time</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>aiomysql.sa.exc.InvalidRequestError: Ambiguous column name <span style="color:#f1fa8c">&#39;id&#39;</span> in result set! try <span style="color:#f1fa8c">&#39;use_labels&#39;</span> option on <span style="color:#ff79c6">select</span> statement.
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is because both the user and jobs tables have the <code>id</code> field, and it will not be possible to determine who it is if returned, you need to use the <code>use_labels</code> parameter,</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>query <span style="color:#ff79c6">=</span> sa<span style="color:#ff79c6">.</span>select([user, jobs], use_labels<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)<span style="color:#ff79c6">.</span>select_from(j)<span style="color:#ff79c6">.</span>where(user<span style="color:#ff79c6">.</span>c<span style="color:#ff79c6">.</span>username <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;yyx&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above result is returned as</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">(</span>2, <span style="color:#f1fa8c">&#39;yyx&#39;</span>, 28, datetime.datetime<span style="color:#ff79c6">(</span>2020, 11, 1, 21, 44, 35<span style="color:#ff79c6">)</span>, True, 2, <span style="color:#f1fa8c">&#39;qa&#39;</span>, 2<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="get-the-return-value-field-property">Get the return value field property</h3>
<p>The above result is a tuple, we can also print the specified fields</p>
<p>When <code>use_labels=True</code> is not used, the field properties of the result can be called directly</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> result<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(i<span style="color:#ff79c6">.</span>username, i<span style="color:#ff79c6">.</span>jobs)
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you add <code>use_labels=True</code>, you also need to add the table name, <code>table name_field</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> result<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(i<span style="color:#ff79c6">.</span>user_username, i<span style="color:#ff79c6">.</span>jobs_jobs)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="do-you-need-to-use-foreign-keys">Do you need to use foreign keys</h2>
<p>No matter whether you use aiomysql or sa, foreign keys are not used for constraints. There are two different opinions in the industry about whether to use foreign keys. Those who support the use will think that there will inevitably be bugs in artificially written programs, and there will be careless It is like inserting data with a userid of 100 into the jobs table, but the user with a userid of 100 is not in the user table. At this time, if a foreign key constraint is used, the insertion will fail. At the level of the mysql database, the Data consistency adds a layer of assurance.</p>
<p>However, those who oppose the use of foreign keys believe that this will increase the burden on the database itself, the consistency and correctness of data should be guaranteed by developers, and the speed of data processing will be affected by the constraints of foreign keys in the database.</p>
<p>Most companies in the industry no longer use foreign keys, and have even disabled this function at the database level to ensure the speed of the database. Therefore, in future development, we will try to use as little or no foreign keys as possible. Of course, This also depends on the business, but if the company bans the foreign keys of mysql, it can only artificially ensure the correctness of the data.</p>
<h2 id="database-reconnection-problem">database reconnection problem</h2>
<p>Sometimes this happens, the database occasionally goes down or network jitters, causing The connection between the program and the database is broken. At this time, when the network is restored, normally we do not want to restart our web service, but the program will automatically reconnect.</p>
<p>Let&rsquo;s write a program to test it</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    conn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>connect(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor(aiomysql<span style="color:#ff79c6">.</span>cursors<span style="color:#ff79c6">.</span>DictCursor) <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where id = 1&#34;</span>)
</span></span><span style="display:flex;"><span>                result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>The program first creates a connect object, and then uses the object to continuously obtain data from the database, and does not perform task operations when an exception occurs.</p>
<p>During the running process of the program, we artificially disconnect the local network to simulate the disconnection of the network. At this time, because the connection between the conn and the database has been lost,</p>
<p>When we restored the network again, the connection still failed to restore automatically.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#39;id&#39;</span>: 1, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: 18, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: datetime.datetime<span style="color:#ff79c6">(</span>2020, 10, 31, 16, 43, 8<span style="color:#ff79c6">)</span>, <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: 0<span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#39;id&#39;</span>: 1, <span style="color:#f1fa8c">&#39;username&#39;</span>: <span style="color:#f1fa8c">&#39;yangyanxing&#39;</span>, <span style="color:#f1fa8c">&#39;age&#39;</span>: 18, <span style="color:#f1fa8c">&#39;updatedate&#39;</span>: datetime.datetime<span style="color:#ff79c6">(</span>2020, 10, 31, 16, 43, 8<span style="color:#ff79c6">)</span>, <span style="color:#f1fa8c">&#39;isstudent&#39;</span>: 0<span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>2020-11-03 18:24:31,206 - asyncio - WARNING - C:<span style="color:#f1fa8c">\P</span>ython37<span style="color:#f1fa8c">\l</span>ib<span style="color:#f1fa8c">\a</span>syncio<span style="color:#f1fa8c">\s</span>elector_events.py<span style="color:#ff79c6">[</span>:863<span style="color:#ff79c6">]</span> - socket.send<span style="color:#ff79c6">()</span> raised exception.
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>....
</span></span></code></pre></td></tr></table>
</div>
</div><p>It keeps printing socket errors.</p>
<p>Let&rsquo;s try using the connection pool</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>create_pool(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor(aiomysql<span style="color:#ff79c6">.</span>cursors<span style="color:#ff79c6">.</span>DictCursor) <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                    c <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where id = 1&#34;</span>)
</span></span><span style="display:flex;"><span>                    result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> result:
</span></span><span style="display:flex;"><span>                        <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop<span style="color:#ff79c6">.</span>run_until_complete(test())
</span></span></code></pre></td></tr></table>
</div>
</div><p>The method of using the connection pool can not automatically reconnect, how can this be good?</p>
<p>Since aiomysql itself does not provide a method for automatic reconnection, we need to re-encapsulate a class here. When executing the execute method, automatically check whether the connection is still valid. If not, try to reconnect. Of course, reconnection may not be possible. On the connection, only the mysql server is online normally, it can connect normally.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> aiomysql
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> functools <span style="color:#ff79c6">import</span> wraps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">mysql_connection_check</span>(func):
</span></span><span style="display:flex;"><span>    @wraps(func)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">wrapper</span>(<span style="color:#ff79c6">*</span>args, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>        mysql <span style="color:#ff79c6">=</span> args[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> mysql:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> mysql<span style="color:#ff79c6">.</span>isconnect:
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># reconnect</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> mysql<span style="color:#ff79c6">.</span>_lock<span style="color:#ff79c6">.</span>acquire()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">await</span> mysql<span style="color:#ff79c6">.</span>restart()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(traceback<span style="color:#ff79c6">.</span>format_exc())
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">await</span> mysql<span style="color:#ff79c6">.</span>_lock<span style="color:#ff79c6">.</span>release()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> func(<span style="color:#ff79c6">*</span>args, <span style="color:#ff79c6">**</span>kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> (OperationalError, ConnectionResetError, OSError):
</span></span><span style="display:flex;"><span>                mysql<span style="color:#ff79c6">.</span>isconnect<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(traceback<span style="color:#ff79c6">.</span>format_exc())
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> wrapper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">PMysql</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    Seal aiomysql to realize automatic reconnection function
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> __init__(self, host, user, password, db, port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>, <span style="color:#ff79c6">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param host:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param user:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param password:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param db:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param port:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param kwargs: minsize=1, maxsize=10, echo=False
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>host <span style="color:#ff79c6">=</span> host
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>user <span style="color:#ff79c6">=</span> user
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>password <span style="color:#ff79c6">=</span> password
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>db <span style="color:#ff79c6">=</span> db
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>port <span style="color:#ff79c6">=</span> port
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>kwargs <span style="color:#ff79c6">=</span> kwargs
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>_lock <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>Lock()
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>_pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">init_pool</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>_pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> aiomysql<span style="color:#ff79c6">.</span>create_pool(
</span></span><span style="display:flex;"><span>                host<span style="color:#ff79c6">=</span>self<span style="color:#ff79c6">.</span>host,
</span></span><span style="display:flex;"><span>                port<span style="color:#ff79c6">=</span>self<span style="color:#ff79c6">.</span>port,
</span></span><span style="display:flex;"><span>                user<span style="color:#ff79c6">=</span>self<span style="color:#ff79c6">.</span>user,
</span></span><span style="display:flex;"><span>                password<span style="color:#ff79c6">=</span>self<span style="color:#ff79c6">.</span>password,
</span></span><span style="display:flex;"><span>                db<span style="color:#ff79c6">=</span>self<span style="color:#ff79c6">.</span>db,
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">**</span>self<span style="color:#ff79c6">.</span>kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">close</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> self<span style="color:#ff79c6">.</span>_pool:
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>wait_closed()
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>_pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;close error&#34;</span>, traceback<span style="color:#ff79c6">.</span>format_exc())
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>pool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">None</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#ff79c6">.</span>isconnect <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">restart</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;will restart connect..... &#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>init_pool()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">execute</span>(self, query, args<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        execute execute statement
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param query:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :return:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(query, args)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> cur
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we repackage a class PMysql, and use the pool returned by <code>aiomysql.create_pool</code> as the _pool attribute of this class. PMysql has an isconnect attribute, which is True only when the connection is normal. After that, we wrote A decorator of <code>mysql_connection_check</code>, which performs query operations in the decorator. When encountering <code>OperationalError, ConnectionResetError, OSError</code> errors, we think it may be related to There is a problem with the mysql database connection and will try to reconnect.</p>
<p>This time, use PMysql to rewrite the test program just now</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    t <span style="color:#ff79c6">=</span> PMysql(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        autocommit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        minsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>        maxsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>init_pool()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>            cur <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;select * from user where id = </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>fetchall():
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(i)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> asyncio<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this time, perform the test just now, the startup program can obtain data normally, and then disconnect from the network, then an error will be reported, and then the network will be restored. At this time, you can automatically connect to the database without restarting the script.</p>
<p>However, due to the re-encapsulation of the class, some methods in aiomysql cannot be used, and it needs to be redefined.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>@mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_a_conn</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>acquire()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">releaseconn</span>(self, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>release(conn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_a_cursor</span>(self, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">release_a_cur</span>(self, cur):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">transaction</span>(self, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>begin()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">commit</span>(self, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">rollback</span>(self, conn):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>rollback()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">execute</span>(self, query, args<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        execute execute statement
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param query:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :param args:
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        :return: cursor
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(query, args)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> cur
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @mysql_connection_check
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">executemany</span>(self, query, args<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> self<span style="color:#ff79c6">.</span>_pool<span style="color:#ff79c6">.</span>acquire() <span style="color:#ff79c6">as</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">async</span> <span style="color:#ff79c6">with</span> conn<span style="color:#ff79c6">.</span>cursor() <span style="color:#ff79c6">as</span> cur:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>executemany(query, args)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> cur
</span></span></code></pre></td></tr></table>
</div>
</div><p>Above, I have repackaged the functions that are used more frequently in the process of normal use, and the processing of transactions will be more troublesome. Here, I use acquire and release to obtain the methods of connection and cursor.</p>
<p>To execute in a transaction we can write like this</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loop <span style="color:#ff79c6">=</span> asyncio<span style="color:#ff79c6">.</span>get_event_loop()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">async</span> <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test</span>():
</span></span><span style="display:flex;"><span>    t <span style="color:#ff79c6">=</span> PMysql(
</span></span><span style="display:flex;"><span>        host<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;127.0.0.1&#39;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">3306</span>,
</span></span><span style="display:flex;"><span>        user<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;root&#39;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;123456&#39;</span>,
</span></span><span style="display:flex;"><span>        db<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;mytest&#39;</span>,
</span></span><span style="display:flex;"><span>        autocommit<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>,
</span></span><span style="display:flex;"><span>        minsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>        maxsize<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>,
</span></span><span style="display:flex;"><span>        loop<span style="color:#ff79c6">=</span>loop)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>init_pool()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    conn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>get_a_conn()
</span></span><span style="display:flex;"><span>    cur <span style="color:#ff79c6">=</span> cur <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>get_a_cursor(conn)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>transaction(conn)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user (username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;xxx&#34;</span>, <span style="color:#bd93f9">11</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> cur<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;insert into user (username, age) values(</span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">%s</span><span style="color:#f1fa8c">)&#34;</span>, (<span style="color:#f1fa8c">&#34;xxx&#34;</span>, <span style="color:#bd93f9">11</span>, <span style="color:#bd93f9">333</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(cur<span style="color:#ff79c6">.</span>lastrowid)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>commit(conn)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">await</span> conn<span style="color:#ff79c6">.</span>rollback()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> cur:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>release_a_cur(cur)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> conn:
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">await</span> t<span style="color:#ff79c6">.</span>releaseconn(conn)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, when inserting data for the second time, an extra parameter 333 is deliberately added, which will cause an exception to be triggered, and then execute <code>await conn.rollback()</code> to check the database again. The above two data are not inserted successfully, so it is in line with Our business needs are gone.</p>
<h2 id="whether-to-use-sqlalchemy">Whether to use sqlalchemy</h2>
<p>Through the above introduction, you can see that sa is not as good as direct SQL statements in terms of code readability, but the significance of sa is that you are using MySQL now, maybe someday the project needs to be migrated to oracle or sqlite, at this time, you can complete the migration smoothly without modifying any code. If you use the SQL language directly, you need to modify a lot of code. In addition, ORM will do some transformations on the query at the bottom layer, such as the injection problem mentioned earlier, If you have handwritten SQL, you will inevitably write loopholes.</p>
<p>However, when we are working on projects, we rarely encounter the situation of modifying the database, so whether to use sa depends on your needs.</p>

    </div>
    <footer class="post-footer">
      

<div class="post-tags">
  
    <a href="/tags/python.html">
    python
  </a>
</div>

<hr/>



<div class="post-copyright">
  <img src="/imgs/cc/cc.svg" width="75" height="75" align="right" />
  <ul>
    <li class="post-copyright-title">
      <strong>Post Title:</strong>
      The use of aiomysql and sqlalchemy
    </li>
    <li class="post-copyright-author">
      <strong>Post Author: </strong>
      KevinYang
    </li>
    <li class="post-copyright-link"> 
      <strong>Post Link:</strong>
       <a id="post-cr-link" href="https://enblog.yangyanxing.com/article/python-aiomysql.html" title="The use of aiomysql and sqlalchemy">https://enblog.yangyanxing.com/article/python-aiomysql.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright Notice: </strong>
      All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target='_blank' href='https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh'>BY-NC-SA</a> unless stating additionally.
    </li>
  </ul>
</div>

  <div class="followme">
  <span>Welcome to my other publishing channels</span>
  <div class="social-list">
    
    <div class="social-item">
        <a target="_blank" class="social-link" href="/image/qrcode.jpg">
          <span class="icon">
            <i class="fab fa-weixin"></i>
          </span>
          <span class="label">WeChat</span>
        </a>
      </div>
    <div class="social-item">
        <a target="_blank" class="social-link" href="/index.xml">
          <span class="icon">
            <i class="fa fa-rss"></i>
          </span>
          <span class="label">RSS</span>
        </a>
      </div>
  </div>
</div>
<div class="post-nav">
  <div class="post-nav-next post-nav-item">
    <a href="https://enblog.yangyanxing.com/article/use-socketio-in-tornado.html" rel="next" title="Tornado integrates socketio (1)">
      <i class="fa fa-chevron-left"></i> Tornado integrates socketio (1)
    </a>
  </div>
  <div class="post-nav-prev post-nav-item">
    <a href="https://enblog.yangyanxing.com/article/python-aiolog.html" rel="prev" title="Send logs asynchronously to a remote server in python">
      Send logs asynchronously to a remote server in python
      <i class="fa fa-chevron-right"></i>
    </a>
  </div>
</div>
    </footer>
  </article>
</div>
<div class="post-comments">
  <div class="comment-head">
    <div class="comment-headline">
      <i class="fas fa-comments fa-fw"></i>
      <span>Comments</span>
    </div>
  </div>
  <div class="comment-wrap">
  
    <div><div class="comment-loading">
  <i class="fa fa-sync fa-spin"></i>
</div>
<script src="https://utteranc.es/client.js" 
repo="kevinkelin/blogissue" 
issue-term="pathname" 
label="comments" 
crossorigin="anonymous" 
theme="preferred-color-scheme" async>
</script>

    </div>
  </div>
</div>

    </div>
  </main>
  <footer class="footer">
    <div class="footer-inner">
<div class="copyright">
  &copy;
  <span itemprop="copyrightYear">
    2010 - 2022
  </span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KevinYang</span>
</div>

<div class="powered-by">
  Power by <a href='https://gohugo.io' target='_blank'>Hugo</a> &amp; <a href='https://github.com/hugo-next/hugo-theme-next' target='_blank'>Hugo NexT.Gemini</a>
</div>


    </div>
  </footer>
  <script type="text/javascript" src="//unpkg.com/animejs@3.2.1/lib/anime.min.js" defer></script>
  <script type="text/javascript" src="//unpkg.com/mathjax@3.2.0/es5/tex-mml-chtml.js" defer></script>




<script type="text/javascript" src="/js/hugo-next.min.fecaee4ce78c0a2bd890f78ab6f3bbbdd405fdd1746fca9c2ddfd9ca82b73fd6.js" defer></script> 
</body>

</html>